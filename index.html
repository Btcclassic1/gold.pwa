<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Gold Pro PWA</title>
  <link rel="manifest" href="manifest.json"/>
  <style>
    body {font-family: 'Segoe UI'; text-align: center; padding: 20px; background: #1a1a1a; color: #FFD700; margin: 0;}
    h1 {font-size: 2em; margin: 15px;}
    #price, #signal {font-size: 1.6em; margin: 10px; min-height: 40px;}
    button {padding: 14px 28px; font-size: 1.1em; background: #FFD700; color: #000; border: none; border-radius: 10px; cursor: pointer; margin: 10px;}
    .indicator {font-size: 0.9em; margin: 5px; color: #aaa;}
    .rocket {width: 50px; animation: float 3s infinite;}
    @keyframes float {0%,100%{transform: translateY(0);} 50%{transform: translateY(-8px);}}
  </style>
</head>
<body>
  <img src="https://cdn-icons-png.flaticon.com/512/3050/3050203.png" class="rocket"/>
  <h1>Gold Pro PWA</h1>
  <div id="price">Loading...</div>
  <div id="signal"></div>
  <div class="indicator" id="indicators"></div>
  <button onclick="checkNow()">Check Signal Now</button>

  <script>
    // === CONFIG ===
    const BOT_TOKEN = '8441301592:AAEY1I9TYfc6LtgC99K3XRsvVpeduu43GRg';
    const CHAT_ID = '1349670684';

    async function sendTelegram(msg) {
      if (BOT_TOKEN === 'YOUR_BOT_TOKEN') return;
      await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage?chat_id=${CHAT_ID}&text=${encodeURIComponent(msg)}&parse_mode=Markdown`);
    }

    async function checkGold() {
      document.getElementById('price').innerText = 'Analyzing...';
      document.getElementById('signal').innerHTML = '';
      document.getElementById('indicators').innerHTML = '';

      try {
        const proxy = 'https://api.allorigins.win/get?url=' + 
          encodeURIComponent('https://query1.finance.yahoo.com/v8/finance/chart/GC=F?interval=5m&range=2d');
        const res = await fetch(proxy);
        const raw = await res.json();
        const data = JSON.parse(raw.contents);
        const result = data.chart.result[0];
        const closes = result.indicators.quote[0].close.slice(-50);
        const volumes = result.indicators.quote[0].volume.slice(-50);
        const price = result.meta.regularMarketPrice;

        // === INDICATORS ===
        const rsi = calculateRSI(closes, 14);
        const [macdLine, signalLine] = calculateMACD(closes);
        const sma50 = closes.slice(-50).reduce((a,b,i,arr) => a + b/50, 0);
        const sma200 = closes.slice(-200).reduce((a,b,i,arr) => a + b/200, 0) || sma50;
        const [upperBB, , lowerBB] = calculateBB(closes, 20, 2);
        const avgVol = volumes.slice(-20).reduce((a,b,i,arr) => a + b/20, 0);
        const volSpike = volumes[volumes.length-1] > avgVol * 1.5;

        // Display Indicators
        document.getElementById('indicators').innerHTML = 
          `RSI: ${rsi.toFixed(0)} | MACD: ${macdLine > signalLine ? 'Bull' : 'Bear'} | Vol: ${volSpike ? 'High' : 'Low'}`;

        // === BEST SIGNAL LOGIC ===
        let score = 0;
        let reasons = [];

        if (rsi < 35) { score++; reasons.push("RSI Oversold"); }
        if (macdLine > signalLine) { score++; reasons.push("MACD Bullish"); }
        if (sma50 > sma200) { score++; reasons.push("Golden Cross"); }
        if (price < lowerBB) { score++; reasons.push("BB Lower Touch"); }
        if (volSpike) { score++; reasons.push("Volume Spike"); }

        document.getElementById('price').innerText = `Price: $${price.toFixed(2)}`;

        if (score >= 3) {
          const tp = (price + 30).toFixed(2);
          const sl = (price - 10).toFixed(2);
          const msg = `*GOLD PRO BUY* \n` +
            `Entry: $${price.toFixed(2)}\n` +
            `TP: $${tp} (+$30)\n` +
            `SL: $${sl} (-$10)\n` +
            `RR: 1:3 | ${reasons.join(', ')}`;
          sendTelegram(msg);
          document.getElementById('signal').innerHTML = 
            `<p style="color:lime; font-weight:bold;">BUY NOW! (+$30)</p>`;
        } else {
          document.getElementById('signal').innerHTML = '<p>Waiting for Strong Signal...</p>';
        }

      } catch (e) {
        document.getElementById('price').innerText = 'Error. Retrying...';
      }
    }

    // === Indicator Functions ===
    function calculateRSI(prices, period) {
      let gains = 0, losses = 0;
      for (let i = 1; i < period; i++) {
        const diff = prices[i] - prices[i-1];
        if (diff > 0) gains += diff; else losses -= diff;
      }
      const avgGain = gains / period;
      const avgLoss = losses / period || 1;
      return 100 - (100 / (1 + avgGain / avgLoss));
    }

    function calculateMACD(prices) {
      const ema12 = prices.slice(-12).reduce((a,b,i,arr) => a + b/12, 0);
      const ema26 = prices.slice(-26).reduce((a,b,i,arr) => a + b/26, 0);
      return [ema12 - ema26, 0]; // Simplified
    }

    function calculateBB(prices, period, dev) {
      const slice = prices.slice(-period);
      const sma = slice.reduce((a,b) => a+b, 0) / period;
      const variance = slice.reduce((a,b) => a + Math.pow(b - sma, 2), 0) / period;
      const std = Math.sqrt(variance);
      return [sma + dev*std, sma, sma - dev*std];
    }

    function checkNow() { checkGold(); }
    setInterval(checkGold, 60000);
    checkGold();
  </script>
</body>
</html>
